# JsonRPC Server

Легковесный http-сервер для создания API по [спецификации JsonRPC](http://www.jsonrpc.org/specification). Сервер не использует никаких внешних зависимостей.

### Кратенько о протоколе

В запросах к серверу всегда отправляется POST сообщение, в теле которого содержится json-запрос типа:

```
{
    "jsonrpc": "2.0",       // Обязательный признак спецификации
    "method": "subtract",   // Обязательное название метода, который должен быть выполнен на сервере
    "params": [42, 23],     // Обязательные параметры для метода - объект или массив
    "id": 1                 // Необязательный идентификатор запроса. Учтите, если его нет - ответ будет пустой, за исключением ошибок (может быть null)
}
```

и в ответ сервер отправляет json-ответ типа:

```
{
    "jsonrpc": "2.0",       // Обязательный признак спецификации
    "result": 19,           // Обязательный результат - может быть любого типа
    "id": 1                 // Идентификатор ответа - всегда равен идентификатору запроса. Если идентификатор получить не удалось (ошибка парсинга) - будет равен null
}
```

или  ошибку

```
{
    "jsonrpc": "2.0",       // Обязательный признак спецификации
    "error": {              // Обязательный объект ошибки
        "code": -32601,                 // Обязательный код ошибки
        "message": "Method not found"   // Обязательное сообщение об ошибке
        "data": "nothing"               // Не обязательные дополнительные данные об ошибке любого типа
    },
    "id": "1"               // Идентификатор ответа - всегда равен идентификатору запроса. Если идентификатор получить не удалось (ошибка парсинга) - будет равен null
}
```



### API
 - **new JsonRPCServer([headers])** - создание экземпляра сервера. Могут быть переданы пользовательские заголовки для ответов. По умолчанию стоят заголовки `CORS` для всех доменов, типов запросов `OPTIONS` и `POST`, заголовков `Accept` и `Content-Type`. В любом случае, заголовок Content-Type будет перезаписан и равен `application/json`.

 - **JsonRPCServer.listen ([port, [interface]])** - запуск сервера.
   - *port* - необязательный аргумент номера порта, который будет слушать сервер. Если не указан, устанавливается 8080
   - *interface* - необязательный аргумент сетевого интерфейса (ip-адрес), который будет слушать сервер. Может устанавливаться только после порта. Если не указан, устанавливается *localhost*
 
 - **JsonRPCServer.on(method, [rules], onRequestCallback(params, response))** - установка реакции на запрос к какому-либо методу `method` jsonrpc.
   - *method* - обязательный аргумент названия метода
   - *rules* - необязательный аргумент правил проверки параметров. Если не указан - параметры останутся в неизменном виде. Подробнее ниже.
   - *onRequestCallback(params, response)* - функция, которая будет вызвана при получении запроса на метод и после проверки параметров. В функцию аргументами передаются:
     - `params` - параметры (очищенные и проверенные, если был указан `rules`)
     - `response` - функция отправки ответа, которую необходимо вызвать для отправки ответа. Функция принимает два аргумента:
       - `error` - пользовательскую ошибку - объект типа `{ code: 1, message: 'user error'}`
       - `result` - результат, если все успешно (первый аргумент должен быть null, 0, false или undefined);

- **rules** - аргумент для метода `.on`. 
  - может отсутствовать (или быть null, undefined, false, '') - тогда содержимое параметров не проверяется (однако свойство params обязательно должно быть объектом или массивом).
  - может равняться `0` - тогда проводится проверка, что параметры - это массив
  - может равняться другому **числу** - тогда проводится проверка, что параметры - это массив длинной в **число**
  - может быть объектом, где свойства - название параметров, которые будут доступны после проверки. Они могут быть:
    - `true` - параметр обязательно должен быть передан
    - `false` - параметр может быть передан, но не обязателен
    - `null` - параметр может быть передан. Если он не передан, он будет доступен и равен `null`


### Пример

1. Установите пакет сервера: `npm install git+https://gitlab.tecel.ru/NodeLibs/jsonrpc-server.git --save`
1. Напишите код:

```
// Подключаем модуль
const JsonRPCServer = require('jsonrpc-server');

// Создаем экземпляр сервера
var server = new JsonRPCServer();

// Обработчик на метод Ping
server.on('Ping', (params, response) => {
    response(null, 'Pong');
});

// Обработчик на метод Hello, с проверкой параметров: свойство title - обязательно
server.on('Hello', {
    title: true
}, (params, response)=>{
    response(null, 'Hello, ' + params.title + '!');
});

// Обработчик на метод Summary - сумма элементов массива без ограничения по длине
server.on('Summary', 0, (params, response) => {
    let sum = 0;
    for (let i in params) {
        sum += params[i];
    }
    response(null, sum);
});

// Возврат ошибки
server.on('ItIsNotWork', (params, response)=>{
    response({
        code: 1,
        message: 'Custom error'
    });
});

// Если в результате выполнения может быть как ошибка, так и результат и необходимо разобрать
server.on('WorkOrNotWork', (params, response)=>{
    // Выполняем какую-то логику
    myFunc((err, result) => {
        response(err, result);
    });
});

// Запустим сервер
server.listen();

```